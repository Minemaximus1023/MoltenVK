From 1234567890abcdef1234567890abcdef12345678 Mon Sep 17 00:00:00 2001
From: V380-Ori <infiniteloop0finsanity@gmail.com>
Date: Fri, 20 Dec 2025 12:00:00 +0200
Subject: [PATCH] Force MSL 4.0 by default on macOS.

---
 Common/MVKCommonEnvironment.h                      | 15 +++++++++++++++
 MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.h | 14 ++++++++------
 MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.mm | 20 ++++++++++++++------
 MoltenVK/MoltenVK/GPUObjects/MVKDevice.mm          | 14 ++++++++++++++
 MoltenVK/MoltenVK/GPUObjects/MVKImage.mm           |  6 ++++--
 MoltenVK/MoltenVK/Layers/MVKExtensions.def         |  6 ++++--
 6 files changed, 59 insertions(+), 16 deletions(-)

diff --git a/Common/MVKCommonEnvironment.h b/Common/MVKCommonEnvironment.h
index ec7ab835..abcd1234 100644
--- a/Common/MVKCommonEnvironment.h
+++ b/Common/MVKCommonEnvironment.h
@@ -86,6 +86,21 @@ extern "C" {
 #   define MVK_OS_SIMULATOR         TARGET_OS_SIMULATOR
 #endif
 
+/**
+ * Force Metal Shading Language Version 4.0 on macOS.
+ *
+ * MSL 4.0 enables the latest Metal features available on macOS 14+.
+ * When enabled, older GPUs or OS versions may not support compilation.
+ *
+ * Enabled by default.
+ */
+#if MVK_MACOS
+#ifndef MVK_USE_MSL_4_0
+#   define MVK_USE_MSL_4_0          1
+#endif
+#endif
+
 /** Building with Xcode versions. */
 #ifndef MVK_XCODE_26
 #   define MVK_XCODE_26             ((__MAC_OS_X_VERSION_MAX_ALLOWED >= 260000) || \
diff --git a/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.h b/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.h
index 8cce5c2f..abcd1234 100644
--- a/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.h
+++ b/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.h
@@ -86,10 +86,16 @@ struct MVKResourceBinder {
 struct MVKVertexBufferBinder {
     SEL _setBuffer;
     SEL _setOffset;
-#if !MVK_USE_MSL_2_4
+#if !MVK_USE_MSL_4_0
     SEL _setBufferDynamic;
     SEL _setOffsetDynamic;
 #endif
     template <typename T> static MVKVertexBufferBinder Create() {
-#if !MVK_USE_MSL_2_4
+#if !MVK_USE_MSL_4_0
         return { T::selSetBuffer(), T::selSetOffset(), T::selSetBufferDynamic(), T::selSetOffsetDynamic() };
 #else
         return { T::selSetBuffer(), T::selSetOffset() };
@@ -98,10 +104,18 @@ struct MVKVertexBufferBinder {
     void setBufferDynamic(id<MTLCommandEncoder> encoder, id<MTLBuffer> buffer, NSUInteger offset, NSUInteger stride, NSUInteger index) const {
-#if !MVK_USE_MSL_2_4
+#if !MVK_USE_MSL_4_0
         reinterpret_cast<void(*)(id, SEL, id<MTLBuffer>, NSUInteger, NSUInteger, NSUInteger)>(objc_msgSend)(encoder, _setBufferDynamic, buffer, offset, stride, index);
 #else
         assert(0);
 #endif
     }
     
diff --git a/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.mm b/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.mm
index 16fd614d..abcd1234 100644
--- a/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.mm
+++ b/MoltenVK/MoltenVK/Commands/MVKCommandEncoderState.mm
@@ -88,8 +88,10 @@ static void setSampler(id<MTLRenderCommandEncoder> encoder, id<MTLSamplerState>
     static SEL selSetTexture() { return @selector(setVertexTexture:atIndex:); }
     static SEL selSetSampler() { return @selector(setVertexSamplerState:atIndex:); }
     static MVKResourceBinder::UseResource useResource() { return useResourceGraphics; }
-#if !MVK_USE_MSL_2_4
+#if !MVK_USE_MSL_4_0
     static SEL selSetBufferDynamic() { return @selector(setVertexBuffer:offset:attributeStride:atIndex:); }
     static SEL selSetOffsetDynamic() { return @selector(setVertexBufferOffset:attributeStride:atIndex:); }
+#endif
@@ -97,10 +99,18 @@ static void setBufferOffset(id<MTLRenderCommandEncoder> encoder, NSUInteger offs
     }
     static void setBufferDynamic(id<MTLRenderCommandEncoder> encoder, id<MTLBuffer> buffer, NSUInteger offset, NSUInteger stride, NSUInteger index) {
-#if !MVK_USE_MSL_2_4
+#if !MVK_USE_MSL_4_0
         [encoder setVertexBuffer:buffer offset:offset attributeStride:stride atIndex:index];
 #else
         assert(0);
 #endif
     }
diff --git a/MoltenVK/MoltenVK/GPUObjects/MVKDevice.mm b/MoltenVK/MoltenVK/GPUObjects/MVKDevice.mm
index 31e9c4ae..abcd1234 100644
--- a/MoltenVK/MoltenVK/GPUObjects/MVKDevice.mm
+++ b/MoltenVK/MoltenVK/GPUObjects/MVKDevice.mm
@@ -2609,6 +2611,18 @@
         setMSLVersion(2, 3);
     }
 
-#if MVK_USE_MSL_2_4
-    if ( mvkOSVersionIsAtLeast(12.0) ) {
-        _metalFeatures.mslVersionEnum = MTLLanguageVersion2_4;
-        setMSLVersion(2, 4);
-    }
-#endif
+#if MVK_USE_MSL_4_0
+    // MSL 4.0 requires macOS 14.0 (Sonoma) or newer
+    if ( mvkOSVersionIsAtLeast(14.0) ) {
+        _metalFeatures.mslVersionEnum = MTLLanguageVersion4_0;
+        setMSLVersion(4, 0);
+    }
+#endif



